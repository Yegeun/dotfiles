#!/usr/bin/env bash

# Get paths dynamically
FZF=$(command -v fzf)
TMUX_BIN=$(command -v tmux)

# Create a temporary file to store directory mappings
tmpfile=$(mktemp)
find ~/Developer -mindepth 1 -maxdepth 1 -type d -exec basename {} \; > "$tmpfile"
echo "dotfiles" >> "$tmpfile"

# Capture both query and selection from fzf, showing only folder names
fzf_output=$(cat "$tmpfile" | $FZF \
    --print-query \
    --reverse \
    --height 90% \
    --border rounded \
    --prompt "  " \
    --pointer " " \
    --marker "âœ“ " \
    --header "SESSION MANAGER" \
    --color "pointer:9,spinner:92,marker:46,fg:7,bg:-1,hl:4,fg+:15,bg+:0,hl+:12,info:8,prompt:4,border:8" \
    --preview 'if [[ "{}" == "dotfiles" ]]; then
                   ls -la --color=always ~/dotfiles 2>/dev/null
               elif [[ -d ~/Developer/{} ]]; then
                   ls -la --color=always ~/Developer/{} 2>/dev/null
               else
                   echo "New directory will be created at:"
                   echo "  ~/Developer/{}"
               fi' \
    --preview-window 'right:55%:border-rounded' \
    --bind 'ctrl-u:preview-page-up,ctrl-d:preview-page-down,?:toggle-preview')

rm -f "$tmpfile"

query=$(echo "$fzf_output" | head -n1)
selected_name=$(echo "$fzf_output" | tail -n1)

new_folder_created=false
uv_project=false
uv_tdd_project=false

# Check if query starts with "uvtddnew:" to create a TDD Python project
if [[ $query == uvtddnew:* ]]; then
    folder_name="${query#uvtddnew:}"
    folder_name=$(echo "$folder_name" | xargs)
    selected="$HOME/Developer/$folder_name"

    if [[ ! -d $selected ]]; then
        mkdir -p "$selected"
        new_folder_created=true
        uv_tdd_project=true
    fi
# Check if query starts with "uvnew:" to create a new Python project
elif [[ $query == uvnew:* ]]; then
    folder_name="${query#uvnew:}"
    folder_name=$(echo "$folder_name" | xargs)
    selected="$HOME/Developer/$folder_name"

    if [[ ! -d $selected ]]; then
        mkdir -p "$selected"
        new_folder_created=true
        uv_project=true
    fi
# Check if query starts with "new:" to create a new folder
elif [[ $query == new:* ]]; then
    folder_name="${query#new:}"
    folder_name=$(echo "$folder_name" | xargs)
    selected="$HOME/Developer/$folder_name"

    if [[ ! -d $selected ]]; then
        mkdir -p "$selected"
        new_folder_created=true
    fi
# Map the selected folder name back to full path
elif [[ -n $selected_name ]]; then
    if [[ "$selected_name" == "dotfiles" ]]; then
        selected="$HOME/dotfiles"
    else
        selected="$HOME/Developer/$selected_name"
    fi
else
    selected=""
fi

# If no selection but we have a query, use the query
if [[ -z $selected ]] && [[ -n $query ]]; then
    selected="$HOME/Developer/$query"
    if [[ ! -d $selected ]]; then
        mkdir -p "$selected"
        new_folder_created=true
    fi
fi

if [[ -z $selected ]]; then
    # If no selection, start or attach to a default session
    if [[ -z $TMUX ]]; then
        exec $TMUX_BIN new-session -A -s default
    fi
    exit 0
fi

# Get session name from the path
session_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    exec $TMUX_BIN new-session -s $session_name -c $selected
fi

if [[ -z $TMUX ]]; then
    # Not in tmux, so attach to existing or create new
    exec $TMUX_BIN new-session -A -s $session_name -c $selected
fi

# Already in tmux, switch to the session
if ! $TMUX_BIN has-session -t=$session_name 2>/dev/null; then
    $TMUX_BIN new-session -ds $session_name -c $selected
fi

$TMUX_BIN switch-client -t $session_name

# Only cd into the folder if we just created it
if [[ $new_folder_created == true ]]; then
    $TMUX_BIN send-keys -t $session_name "cd \"$selected\"" C-m

    # Initialize uv project if uvnew: was used
    if [[ $uv_project == true ]]; then
        $TMUX_BIN send-keys -t $session_name "uv init" C-m
    fi

    # Initialize TDD project if uvtddnew: was used
    if [[ $uv_tdd_project == true ]]; then
        project_name=$(basename "$selected" | tr '-' '_')
        $TMUX_BIN send-keys -t $session_name "uv init && uv add --dev pytest && rm -f main.py && mkdir -p src/$project_name tests && touch src/$project_name/__init__.py tests/__init__.py" C-m
        $TMUX_BIN send-keys -t $session_name "cat > src/$project_name/main.py << 'EOF'
def add(a, b):
    return a + b
EOF" C-m
        $TMUX_BIN send-keys -t $session_name "cat > conftest.py << 'EOF'
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent / \"src\"))
EOF" C-m
        $TMUX_BIN send-keys -t $session_name "cat > tests/test_main.py << 'EOF'
from ${project_name}.main import add

def test_add():
    assert add(1, 2) == 3
EOF" C-m
    fi

    $TMUX_BIN send-keys -t $session_name "clear" C-m
fi
