#!/usr/bin/env bash

# Create a temporary file to store directory mappings
tmpfile=$(mktemp)
find ~/Developer -mindepth 1 -maxdepth 1 -type d -exec basename {} \; > "$tmpfile"
echo "dotfiles" >> "$tmpfile"

# Capture both query and selection from fzf, showing only folder names
fzf_output=$(cat "$tmpfile" | /opt/homebrew/bin/fzf \
    --print-query \
    --reverse \
    --height 90% \
    --border rounded \
    --prompt "  " \
    --pointer " " \
    --marker "âœ“ " \
    --header "SESSION MANAGER" \
    --color "pointer:9,spinner:92,marker:46,fg:7,bg:-1,hl:4,fg+:15,bg+:0,hl+:12,info:8,prompt:4,border:8" \
    --preview 'if [[ "{}" == "dotfiles" ]]; then
                   ls -la --color=always ~/dotfiles 2>/dev/null
               elif [[ -d ~/Developer/{} ]]; then
                   ls -la --color=always ~/Developer/{} 2>/dev/null
               else
                   echo "New directory will be created at:"
                   echo "  ~/Developer/{}"
               fi' \
    --preview-window 'right:55%:border-rounded' \
    --bind 'ctrl-u:preview-page-up,ctrl-d:preview-page-down,?:toggle-preview')

rm -f "$tmpfile"

query=$(echo "$fzf_output" | head -n1)
selected_name=$(echo "$fzf_output" | tail -n1)

new_folder_created=false
uv_project=false

# Check if query starts with "uvnew:" to create a new Python project
if [[ $query == uvnew:* ]]; then
    folder_name="${query#uvnew:}"
    folder_name=$(echo "$folder_name" | xargs)
    selected="$HOME/Developer/$folder_name"

    if [[ ! -d $selected ]]; then
        mkdir -p "$selected"
        new_folder_created=true
        uv_project=true
    fi
# Check if query starts with "new:" to create a new folder
elif [[ $query == new:* ]]; then
    folder_name="${query#new:}"
    folder_name=$(echo "$folder_name" | xargs)
    selected="$HOME/Developer/$folder_name"

    if [[ ! -d $selected ]]; then
        mkdir -p "$selected"
        new_folder_created=true
    fi
# Map the selected folder name back to full path
elif [[ -n $selected_name ]]; then
    if [[ "$selected_name" == "dotfiles" ]]; then
        selected="$HOME/dotfiles"
    else
        selected="$HOME/Developer/$selected_name"
    fi
else
    selected=""
fi

# If no selection but we have a query, use the query
if [[ -z $selected ]] && [[ -n $query ]]; then
    selected="$HOME/Developer/$query"
    if [[ ! -d $selected ]]; then
        mkdir -p "$selected"
        new_folder_created=true
    fi
fi

if [[ -z $selected ]]; then
    # If no selection, start or attach to a default session
    if [[ -z $TMUX ]]; then
        exec /opt/homebrew/bin/tmux new-session -A -s default
    fi
    exit 0
fi

# Get session name from the path
session_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    exec /opt/homebrew/bin/tmux new-session -s $session_name -c $selected
fi

if [[ -z $TMUX ]]; then
    # Not in tmux, so attach to existing or create new
    exec /opt/homebrew/bin/tmux new-session -A -s $session_name -c $selected
fi

# Already in tmux, switch to the session
if ! /opt/homebrew/bin/tmux has-session -t=$session_name 2>/dev/null; then
    /opt/homebrew/bin/tmux new-session -ds $session_name -c $selected
fi

/opt/homebrew/bin/tmux switch-client -t $session_name

# Only cd into the folder if we just created it
if [[ $new_folder_created == true ]]; then
    /opt/homebrew/bin/tmux send-keys -t $session_name "cd \"$selected\"" C-m

    # Initialize uv project if uvnew: was used
    if [[ $uv_project == true ]]; then
        /opt/homebrew/bin/tmux send-keys -t $session_name "uv init && uv venv && source .venv/bin/activate" C-m
    fi

    /opt/homebrew/bin/tmux send-keys -t $session_name "clear" C-m
fi
